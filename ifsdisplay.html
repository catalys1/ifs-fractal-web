<html>
<head>
    <link rel='stylesheet' href='stylesheet.css'>
</head>
<body onload="startup();">
<div class='col'>

    <div class='row align-end'>
        <span style="padding-left:10px;">
            <label for='iters'>Iterations</label>
            <input id='iters' type='number' value=100000 min=0 max=500000 step=1000 oninput="renderFractal(system)"></input>
        </span>
        <span style="padding-left:10px;">
            <label for='probs'>Probabilities:</label>
            <select id='probs' name='probs' oninput="renderFractal(system)">
                <option value='det'>Determinant</option>
                <option value='uniform'>Uniform</option>
            </select>
        </span>
        <span style="padding-left:10px;">
            <label for='systems'>Probabilities:</label>
            <select id='systems' name='systems' oninput="predefinedSystem(null)">
                <option value='dragon'>Dragon</option>
                <option value='fern'>Fern</option>
            </select>
        </span>
    </div>
    <div class='row'>
        <div>
            <canvas id="ifs-canvas" height='400' width='400'> </canvas>
        </div>
        <div>
            <canvas id='decomp-canvas' width=400 height=400></canvas>
        </div>
        <div>
            <canvas id='info-canvas' class='no-border' width=400 height=400></canvas>
        </div>
    </div>

    <div class='row'>
        <div class='col'>
            <div class='header'>System parameters</div>
            <div class='row'>
                <input id='system-size' type='number' min=2 max=16 value=2 oninput='changeSystemSize()'></input>
                <label for='system-size' style="padding-left:10px;">Number of transforms</label>
            </div>
            <div class='row'>
                <input id='step-size' type='number' min='0.01' max='0.5' value='0.1' step='0.01'>
                </input>
                <label for='step-size' style="padding-left:10px;">Step size</label>
            </div>
            <div id='params' class='col'></div>
            <button onclick="sampleRandomSystem()">Random</button>
        </div>
        <div class='col'>
            <textarea id='entry-field' name='entry-field' cols="50" rows="12" placeholder="Enter a system"></textarea>
            <button id='submit-system' onclick="formSubmitSystem()">Submit</button>
        </div>
    </div>
</div>
</body>

<script src=ifs.js></script>
<script src=manipulate.js></script>
<script>

// Global state
var system = null;
var fillRate = 0;
var manipulator;
// -------------------------------------------------------
// Predefined systems
var predefined = {
    dragon: [[[0.5, -0.5, 0], [0.5, 0.5,  0]],
            [[-0.5, -0.5, 1], [0.5, -0.5,  0]]],
    fern:   [[[0, 0, 0], [0, 0.25, -0.4]],
            [[0.95, 0.005, -0.002], [-0.005, 0.93, 0.5]],
            [[0.035, -0.2, -0.09], [0.16, 0.04, 0.02]],
            [[-0.04, 0.2, 0.083], [0.16, 0.04, 0.12]]],
}

function sampleRandomSystem() {
    var n = parseInt(document.getElementById('system-size').value);
    system = randomSystem(n);
    displayParams();
    renderFractal(system);
}

function predefinedSystem(name=null) {
    if (name === null) {
        name = document.getElementById('systems').value;
    }
    if (predefined.hasOwnProperty(name)) {
        system = predefined[name];
        displayParams();
        renderFractal(system);
    }
}

function formSubmitSystem() {
    let text = document.getElementById('entry-field').value;
    try {
        let sys = JSON.parse(text);
        if (sys.length < 2) throw new SyntaxError('Not enough transforms');
        for (let i = 0; i < sys.length; i++) {
            if (sys[i].length !== 2 || sys[i][0].length !== 3 || sys[i][1].length !== 3)
                throw new SyntaxError('System must consist only of 3x2 matrices');
        }
        system = sys;
        document.getElementById('system-size').value = system.length;
        changeSystemSize();
    } catch (SyntaxError) {
        console.log('Input was not a valid system');
    }
}

function renderFractal(sys, force=false) {
    var iters = document.getElementById('iters').value;
    var probs = document.getElementById('probs').value;
    let t1 = performance.now();
    var points = iterateIFS(sys, iters, probs=probs);
    let t2 = performance.now();
    drawPoints(points);
    let t3 = performance.now();
    manipulator.update(sys, force);
    showSystemInfo(system);
    // console.log('iterate(' + (t2-t1) + '), draw(' + (t3-t2) + ')'); 
}

function createMatrixCard() {
    var mat = [[1, 0, 0], [0, 1, 0]];
    var card = document.createElement('div');
    card.classList.add('col')
    for (let i = 0; i < mat.length; i++) {
        var row = document.createElement('span');
        for (let j = 0; j < mat[i].length; j++) {
            var cell = document.createElement('input');
            cell.type = 'number';
            cell.step = document.getElementById('step-size').value;
            let notlast = j < mat[i].length - 1;
            cell.min = notlast ? '-1' : '-10';
            cell.max = notlast ? '1' : '10'
            cell.value = mat[i][j].toPrecision(3);
            cell.oninput = function(ev) {
                let sys = readTextParams();
                renderFractal(sys);
            }
            row.appendChild(cell);
        }
        card.appendChild(row);
    }
    return card;
}

function updateMatrixCard(mat, card) {
    for (let i = 0; i < mat.length; i++) {
        var row = card.children[i];
        for (let j = 0; j < mat[i].length; j++) {
            var cell = row.children[j];
            cell.value = mat[i][j].toPrecision(4);
        }
    }
}

function changeSystemSize() {
    let n = parseInt(document.getElementById('system-size').value, 10);
    let s = system.length;
    if (n > s)
        for (let i = s; i < n; i++) {
            system.push([[1.0,0.0,0.0],[0.0,1.0,0.0]]);
        }
    else if (n < s)
        for (let i = 0; i < s-n; i++)
            system.pop();
    displayParams();
    renderFractal(system, true);
}

function readTextParams() {
    var container = document.getElementById('params');
    var sys = [];
    for (let i = 0; i < container.children.length; i++) {
        var mat = [];
        var mat_els = container.children[i];
        for (let j = 0; j < mat_els.children.length; j++) {
            var row = [];
            let row_els = mat_els.children[j];
            for (let k = 0; k < row_els.children.length; k++) {
                let v = parseFloat(row_els.children[k].value);
                row.push(v);
            }
            mat.push(row);
        }
        sys.push(mat);
    }
    return sys;
}

function displayParams(sys=null) {
    if (sys === null) {
        sys = system;
    }
    var container = document.getElementById('params');
    let nc = container.children.length;
    if (nc > sys.length)
        for (let i = sys.length; i < nc; i++)
            container.removeChild(container.lastChild);
    else if (nc < sys.length)
        for (let i = nc; i < sys.length; i++) {
            let card = createMatrixCard(sys[i]);
            container.appendChild(card);
        }
    for (let i = 0; i < sys.length; i++)
        updateMatrixCard(sys[i], container.children[i]);
}

function drawPoints(points, region=null) {
    var can = document.getElementById('ifs-canvas');
    var ctx = can.getContext('2d');

    if (region === null)
        region = minmax(points);

    var w = can.width;
    var h = can.height;
    ctx.clearRect(0, 0, w, h);
    let id = ctx.getImageData(0 ,0, w, h);
    let pix = id.data;

    var count = 0;
    for (let i = 0; i < points.length; i++) {
        let x = Math.floor((points[i][0] - region[0]) / (region[2]-region[0]) * (w-1));
        let y = Math.floor((points[i][1] - region[1]) / (region[3]-region[1]) * (h-1));
        if (x >= 0 && x < w && y >= 0 && y < h) {
            // ar[y][x] = 1;
            let k = (y*w + x)*4;
            if (pix[k+3] === 0) {
                count++;
                pix[k] = 0;
                pix[k+1] = 0;
                pix[k+2] = 0;
                pix[k+3] = 255;
            }
        }
    }
    fillRate = count / (w*h);
    ctx.putImageData(id, 0, 0);

    // coordinates of corners
    let fsize = 9;
    ctx.fillStyle = '#AAAAAA';
    ctx.font = fsize.toString()+'px courier';
    let p = 3;
    let x1 = region[0].toPrecision(p);
    let y1 = region[1].toPrecision(p);
    let x2 = region[2].toPrecision(p);
    let y2 = region[3].toPrecision(p);
    ctx.textBaseline = 'top';
    ctx.textAlign = 'left';
    let s = '('+x1+','+y1+')';
    ctx.fillText(s, 2, 2);
    s = '('+x2+','+y1+')';
    ctx.textAlign = 'right';
    ctx.fillText(s, w-2, 2);
    s = '('+x1+','+y2+')';
    ctx.textBaseline = 'bottom';
    ctx.textAlign = 'left';
    s = '('+x2+','+y2+')';
    ctx.fillText(s, 2, h-2);
    ctx.textAlign = 'right';
    ctx.fillText(s, w-2, h-2);
}

function showSystemInfo(sys=null) {
    if (sys === null) sys = system;
    var can = document.getElementById('info-canvas');
    var ctx = can.getContext('2d');
    ctx.font = '10px courier';
    ctx.fillStyle = 'black';
    ctx.textAlign = 'left';
    ctx.textBaseline = 'top';

    ctx.clearRect(0, 0, can.width, can.height);

    let xoff = 5, yoff = 5, xspace = 75, yspace = 20;

    ctx.fillText('Sigma1', xoff, yoff);
    ctx.fillText('Sigma2', xoff+xspace, yoff);
    ctx.fillText('det', xoff+2*xspace, yoff);

    ctx.beginPath();
    ctx.moveTo(0, yoff+yspace*2/3);
    ctx.lineTo(can.width, yoff+yspace*2/3);
    ctx.stroke();
    
    var ssum = 0;
    for (let i = 0; i < sys.length; i++) {
        let svd = manipulator.svd[i];
        let y = yoff+(i+1)*yspace;
        ctx.fillText(svd.S[0].toPrecision(6), xoff, y);
        ctx.fillText(svd.S[1].toPrecision(6), xoff+xspace, y);
        ctx.fillText(det2x2(sys[i]).toPrecision(6), xoff+2*xspace, y);
        ssum += svd.S[0] + svd.S[1];
    }

    ctx.fillText('\u03A3_sigmas = '+ssum.toPrecision(8), 
                 xoff, yoff + (sys.length + 2) * yspace)
    ctx.fillText('Fill rate: ' + fillRate.toPrecision(8),
                 xoff, yoff + (sys.length + 3) * yspace)
}

function startup() {
    manipulator = new ManipulateDisplay(document.getElementById('decomp-canvas'), function(sys) {
        renderFractal(sys);
        displayParams(sys);
    });
    system = predefined.fern;
    displayParams();

    var stepper = document.getElementById('step-size');
    stepper.oninput = function(ev) {
        var new_step = stepper.value;
        var container = document.getElementById('params');
        for (let i = 0; i < container.children.length; i++) {
            var mat_els = container.children[i];
            for (let j = 0; j < mat_els.children.length; j++) {
                let row_els = mat_els.children[j];
                for (let k = 0; k < row_els.children.length; k++) {
                    row_els.children[k].step = new_step;
                }
            }
        }

    }

    renderFractal(system);
}

</script>

</html>